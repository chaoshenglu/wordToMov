<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
</head>

<body>
  <div id="text-container">
  </div>

  <script src="tts-core-js.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async function () {
      const textContainer = document.getElementById('text-container');
      
      let en_list = [
        "She wore a thermal sweater to stay warm in the freezing weather.",
        "He filled his thermos with hot coffee before going hiking.",
        "Ice melting is an endothermic process because it absorbs heat from the surroundings.",
        "Burning wood is an exothermic reaction because it releases heat.",
        "The doctor used a thermometer to check if the child had a fever."
      ];

      // TTS配置 - 需要用户提供API Key
      const API_KEY = 'YOUR_GOOGLE_TTS_API_KEY'; // 用户需要替换为实际的API Key
      const tts = new GoogleTTS(API_KEY);
      
      let audioUrls = [];
      let currentSentenceIndex = 0;
      let animationComplete = false;

      // 卡拉OK样式的文字动画
      function createKaraokeAnimation(element, text, duration = 3000) {
        return new Promise((resolve) => {
          element.innerHTML = '';
          
          // 创建每个字符的span
          const chars = text.split('').map(char => {
            const span = document.createElement('span');
            span.textContent = char === ' ' ? '\u00A0' : char; // 使用不间断空格
            span.style.opacity = '0.3';
            span.style.transition = 'all 0.3s ease';
            return span;
          });
          
          chars.forEach(span => element.appendChild(span));
          
          // 计算每个字符的动画延迟
          const charDelay = duration / chars.length;
          
          chars.forEach((span, index) => {
            setTimeout(() => {
              span.style.opacity = '1';
              span.style.color = '#FFD700'; // 金色高亮
              span.style.textShadow = `
                -4px -4px 0 black,
                4px -4px 0 black,
                -4px 4px 0 black,
                4px 4px 0 black,
                0px 4px 0 black,
                0px -4px 0 black,
                4px 0px 0 black,
                -4px 0px 0 black,
                0 0 20px #FFD700
              `;
              
              // 最后一个字符动画完成
              if (index === chars.length - 1) {
                setTimeout(resolve, 300);
              }
            }, index * charDelay);
          });
        });
      }

      // 预加载所有音频
      async function preloadAudio() {
        console.log('开始预加载音频...');
        
        for (let i = 0; i < en_list.length; i++) {
          try {
            console.log(`正在转换第 ${i + 1} 个句子...`);
            const audioUrl = await tts.textToSpeech(en_list[i], 'female');
            audioUrls.push(audioUrl);
            console.log(`第 ${i + 1} 个音频转换完成`);
          } catch (error) {
            console.error(`转换第 ${i + 1} 个句子失败:`, error);
            // 如果TTS失败，使用空的音频URL，但仍然显示文字动画
            audioUrls.push(null);
          }
        }
        
        console.log('所有音频预加载完成');
        return audioUrls;
      }

      // 播放句子（音频+动画）
      async function playSentence(index) {
        if (index >= en_list.length) {
          animationComplete = true;
          document.body.setAttribute('data-animation-complete', 'true');
          return;
        }

        const sentence = en_list[index];
        const audioUrl = audioUrls[index];
        
        // 创建句子容器
        const p = document.createElement('p');
        p.className = 'sentence';
        textContainer.appendChild(p);
        
        // 如果有音频，播放音频
        let audio = null;
        let audioDuration = 3000; // 默认3秒
        
        if (audioUrl) {
          audio = new Audio(audioUrl);
          
          // 获取音频时长
          await new Promise((resolve) => {
            audio.addEventListener('loadedmetadata', () => {
              audioDuration = audio.duration * 1000; // 转换为毫秒
              resolve();
            });
            audio.addEventListener('error', () => {
              console.warn(`音频 ${index + 1} 加载失败，使用默认时长`);
              resolve();
            });
          });
          
          audio.play().catch(e => {
            console.warn(`音频 ${index + 1} 播放失败:`, e);
          });
        }
        
        // 开始卡拉OK动画
        await createKaraokeAnimation(p, sentence, Math.max(audioDuration, 2000));
        
        // 等待一小段时间再播放下一句
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // 播放下一句
        currentSentenceIndex++;
        await playSentence(currentSentenceIndex);
      }

      // 开始动画序列
      async function startAnimation() {
        try {
          // 预加载音频
          await preloadAudio();
          
          // 等待1秒让puppeteer准备好
          await new Promise(resolve => setTimeout(resolve, 1000));
          
          // 开始播放句子
          await playSentence(0);
          
        } catch (error) {
          console.error('动画启动失败:', error);
          // 即使TTS失败，也要设置动画完成标记
          document.body.setAttribute('data-animation-complete', 'true');
        }
      }

      // 启动动画
      startAnimation();
    });
  </script>
</body>

</html>

<style>
  html,
  body {
    margin: 0;
    padding: 0;
    background: transparent;
    width: 1080px;
    height: 1920px;
    overflow: hidden;
    color: white;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  }

  #text-container {
    padding: 40px;
    text-align: center;
    display: flex;
    flex-direction: column;
    justify-content: center;
    height: 100vh;
  }

  .sentence {
    margin: 40px 0;
    word-break: break-word;
    text-align: center;
    font-size: 60px;
    color: white;
    line-height: 1.2;
    text-shadow:
      -4px -4px 0 black,
      4px -4px 0 black,
      -4px 4px 0 black,
      4px 4px 0 black,
      0px 4px 0 black,
      0px -4px 0 black,
      4px 0px 0 black,
      -4px 0px 0 black;
  }

  .sentence span {
    display: inline;
  }
</style>